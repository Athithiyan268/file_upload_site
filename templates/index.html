<!DOCTYPE html>
<html>
<head>
<title>File Manager</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body { background-color: #f8f9fa; }
.card { border-radius: 12px; }
</style>
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
    <span class="navbar-brand">üìÅ File Manager</span>

    <div class="d-flex gap-2">
      {% if current_user.role == 'admin' %}
      <a href="/admin" class="btn btn-warning btn-sm">Admin</a>
      {% endif %}
      <a href="/trash" class="btn btn-secondary btn-sm">Trash</a>
      <button class="btn btn-outline-light btn-sm" onclick="toggleTheme()">üåô</button>
      <a href="/logout" class="btn btn-danger btn-sm">Logout</a>
      <a href="/logs" class="btn btn-outline-light btn-sm">Logs</a>
      <a href="/analytics" class="btn btn-outline-light btn-sm">Analytics</a>


    </div>
  </div>
</nav>

<!-- FLASH MESSAGES -->
{% with messages = get_flashed_messages() %}
{% if messages %}
<div class="container mt-3">
  {% for msg in messages %}
  <div class="alert alert-success alert-dismissible fade show">
    {{ msg }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  {% endfor %}
</div>
{% endif %}
{% endwith %}

<div class="container mt-4">

<!-- STORAGE BAR -->
<div class="card mb-4">
  <div class="card-body">
    <strong>Storage Usage</strong>
    <div class="progress mt-2">
      <div class="progress-bar bg-success"
           style="width: {{ (used / quota * 100)|round(1) }}%">
        {{ (used / 1024 / 1024)|round(1) }} MB /
        {{ (quota / 1024 / 1024)|round(0) }} MB
      </div>
    </div>
  </div>
</div>

<!-- DRAG & DROP UPLOAD -->
<form method="POST" action="/upload" enctype="multipart/form-data"
      class="border p-4 text-center bg-white mb-4"
      ondrop="dropHandler(event)" ondragover="dragOverHandler(event)">
  <input type="file" name="file" id="fileInput" hidden>
  <h5>üì§ Drag & Drop files here</h5>
  <p>or</p>
  <button type="button" class="btn btn-primary"
          onclick="document.getElementById('fileInput').click()">
    Select File
  </button>
</form>

<!-- FILE TABLE -->
<form method="POST" action="/download/bulk">

<table class="table table-hover align-middle">
<thead>
<tr>
  <th><input type="checkbox" onclick="toggleAll(this)"></th>
  <th>File</th>
  <th>Size</th>
  <th>Actions</th>
</tr>
</thead>

<tbody>
{% for file in files %}
<tr>
  <td><input type="checkbox" name="file_ids" value="{{ file.id }}"></td>

  <td>
    {% if file.name.endswith('.pdf') %}
      <i class="fa-solid fa-file-pdf text-danger"></i>
    {% elif file.name.endswith('.jpg') or file.name.endswith('.png') %}
      <i class="fa-solid fa-file-image text-success"></i>
    {% elif file.name.endswith('.zip') %}
      <i class="fa-solid fa-file-zipper text-warning"></i>
    {% else %}
      <i class="fa-solid fa-file text-secondary"></i>
    {% endif %}
    {{ file.name }}
  </td>

  <td>{{ (file.size / 1024)|round(2) }} KB</td>

  <td>
    <a href="/preview/{{ file.id }}" target="_blank" class="btn btn-info btn-sm">Preview</a>
    <a href="/download/{{ file.id }}" class="btn btn-primary btn-sm">Download</a>

    <form method="POST" action="/share/{{ file.id }}" class="d-inline">
      <input type="hidden" name="hours" value="24">
      <a href="/share/{{ file.id }}" class="btn btn-warning btn-sm">Share</a>
    </form>

    <form method="POST" action="/delete/{{ file.id }}" class="d-inline">
      <button class="btn btn-danger btn-sm">Trash</button>
    </form>
  </td>
</tr>
{% endfor %}
</tbody>
</table>

<button class="btn btn-success mt-2">Download Selected (ZIP)</button>
</form>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
function toggleAll(source) {
  document.querySelectorAll('input[name="file_ids"]').forEach(cb => cb.checked = source.checked);
}

function dragOverHandler(ev) { ev.preventDefault(); }
function dropHandler(ev) {
  ev.preventDefault();
  document.getElementById('fileInput').files = ev.dataTransfer.files;
  ev.target.closest('form').submit();
}

function toggleTheme() {
  document.body.classList.toggle("bg-dark");
  document.body.classList.toggle("text-light");
}
</script>

</body>
</html>
